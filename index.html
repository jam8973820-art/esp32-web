<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ESP32-S3 家電控制</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  text-align: center;
  margin: 0;
  padding-bottom: 80px;
}

h2 { margin: 16px 0; }

#status {
  margin-bottom: 10px;
  font-size: 16px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  max-width: 360px;
  margin: auto;
}

button {
  height: 70px;
  font-size: 18px;
  border-radius: 8px;
  border: none;
  background: #aaa;
  color: white;
  cursor: pointer;
}

button.on { background: #2ecc71; }

#micBtn {
  margin: 15px;
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 20px;
  background: #4285f4;
  color: white;
  border: none;
}

#voiceArea {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  border-top: 1px solid #ddd;
  padding: 10px;
}

#voiceText {
  min-height: 24px;
  font-size: 16px;
}
</style>
</head>

<body>

<h2>ESP32-S3 家電控制</h2>
<div id="status">MQTT 連線中...</div>

<div class="grid" id="buttons"></div>

<button id="micBtn">🎤 語音控制</button>

<div id="voiceArea">
  <div id="voiceText">請說指令…</div>
</div>

<script>
const DEVICE_NAMES = [
  "房間電燈",
  "戶外電燈",
  "客廳電燈",
  "客廳風扇",
  "設備5",
  "設備6",
  "設備7",
  "設備8",
  "設備9"
];

const BROKER = "wss://yb01715d.ala.asia-southeast1.emqxsl.com:8084/mqtt";
const USERNAME = "jyhon";
const PASSWORD = "jyhon";
const TOPIC_CMD   = "jam1liau2/item1";
const TOPIC_REPLY = "jam1liau2/reply";
const CLIENT_ID = "web_" + Math.random().toString(16).substr(2, 8);

const deviceState = {};
const buttonsDiv = document.getElementById("buttons");

DEVICE_NAMES.forEach((name, i) => {
  const id = i + 1;
  deviceState[id] = false;
  const btn = document.createElement("button");
  btn.id = "btn" + id;
  btn.innerText = `${name}（關）`;
  btn.onclick = () => toggleDevice(id);
  buttonsDiv.appendChild(btn);
});

const client = mqtt.connect(BROKER, {
  username: USERNAME,
  password: PASSWORD,
  clientId: CLIENT_ID,
  reconnectPeriod: 3000
});

/* 修正 1：連線成功後，明確訂閱 TOPIC_REPLY 並在無錯誤時發送 STATUS */
client.on("connect", () => {
  document.getElementById("status").innerText = "MQTT 已連線";
  client.subscribe(TOPIC_REPLY, (err) => {
    if (!err) {
      console.log("訂閱成功，準備發送 STATUS");
      client.publish(TOPIC_CMD, "STATUS");
    }
  });
});

client.on("message", (topic, message) => {
  if (topic !== TOPIC_REPLY) return;
  const text = message.toString().trim();
  console.log("收到訊息:", text);

  /* 修正 2：解析 powerXXXXXXXXX (不區分大小寫，確保長度正確) */
  if (text.toLowerCase().startsWith("power") && text.length >= 14) {
    const bits = text.substring(5);
    for (let i = 0; i < 9; i++) {
      const id = i + 1;
      deviceState[id] = (bits[i] === '1');
      updateButton(id);
    }
    return;
  }

  const m = text.match(/#(\d+)\s+power\s+(on|off)/i);
  if (m) {
    const id = parseInt(m[1]);
    deviceState[id] = (m[2].toLowerCase() === "on");
    updateButton(id);
  }
});

function toggleDevice(id) {
  const payload = id + (deviceState[id] ? "0" : "1");
  client.publish(TOPIC_CMD, payload);
}

function updateButton(id) {
  const btn = document.getElementById("btn" + id);
  if (!btn) return;
  const name = DEVICE_NAMES[id - 1];
  if (deviceState[id]) {
    btn.classList.add("on");
    btn.innerText = `${name}（開）`;
  } else {
    btn.classList.remove("on");
    btn.innerText = `${name}（關）`;
  }
}

/* 語音部分保持原樣 */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SpeechRecognition) {
  const recognition = new SpeechRecognition();
  recognition.lang = "zh-TW";
  recognition.interimResults = true;
  recognition.onstart = () => { document.getElementById("voiceText").innerText = "🎧 聆聽中..."; };
  recognition.onresult = (e) => {
    const text = e.results[0][0].transcript;
    document.getElementById("voiceText").innerText = text;
    handleVoice(text);
  };
  recognition.onend = () => { setTimeout(() => document.getElementById("voiceText").innerText = "請說指令…", 2000); };
  document.getElementById("micBtn").onclick = () => recognition.start();
}

function handleVoice(text) {
  const isOn  = /開|打開|開啟/.test(text);
  const isOff = /關|關閉/.test(text);
  if (!isOn && !isOff) return;
  let id = null;
  DEVICE_NAMES.forEach((name, i) => { if (text.includes(name)) id = i + 1; });
  const m = text.match(/第?\s*(\d+)/);
  if (!id && m) id = parseInt(m[1]);
  if (id >= 1 && id <= 9) {
    client.publish(TOPIC_CMD, id + (isOn ? "1" : "0"));
  }
}
</script>
</body>
</html>