<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ESP32-S3 家電控制</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  text-align: center;
  margin: 0;
  padding-bottom: 80px;
}

h2 { margin: 16px 0; }

#status {
  margin-bottom: 10px;
  font-size: 16px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  max-width: 360px;
  margin: auto;
}

button {
  height: 70px;
  font-size: 18px;
  border-radius: 8px;
  border: none;
  background: #aaa;
  color: white;
  cursor: pointer;
}

button.on { background: #2ecc71; }

#micBtn {
  margin: 15px;
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 20px;
  background: #4285f4;
  color: white;
  border: none;
}

#voiceArea {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  border-top: 1px solid #ddd;
  padding: 10px;
}

#voiceText {
  min-height: 24px;
  font-size: 16px;
}
</style>
</head>

<body>

<h2>ESP32-S3 家電控制</h2>
<div id="status">MQTT 連線中...</div>

<div class="grid" id="buttons"></div>

<button id="micBtn">🎤 語音控制</button>

<div id="voiceArea">
  <div id="voiceText">請說指令…</div>
</div>

<script>
/* ===== 裝置名稱 ===== */
const DEVICE_NAMES = [
  "房間電燈",
  "戶外電燈",
  "客廳電燈",
  "客廳風扇",
  "設備5",
  "設備6",
  "設備7",
  "設備8",
  "設備9"
];

/* ===== MQTT 設定 ===== */
const BROKER = "wss://yb01715d.ala.asia-southeast1.emqxsl.com:8084/mqtt";
const USERNAME = "jyhon";
const PASSWORD = "jyhon";
const CLIENT_ID = "web_" + Math.random().toString(16).substr(2, 8);

const deviceState = {};
const buttonsDiv = document.getElementById("buttons");

/* 建立按鈕 */
DEVICE_NAMES.forEach((name, i) => {
  const id = i + 1;
  deviceState[id] = false;
  const btn = document.createElement("button");
  btn.id = "btn" + id;
  btn.innerText = `${name}（關）`;
  btn.onclick = () => toggleDevice(id);
  buttonsDiv.appendChild(btn);
});

/* MQTT 連線 */
const client = mqtt.connect(BROKER, {
  username: USERNAME,
  password: PASSWORD,
  clientId: CLIENT_ID,
  reconnectPeriod: 3000
});

client.on("connect", () => {
  document.getElementById("status").innerText = "MQTT 已連線";

  // 訂閱所有 sw*/state 主題
  for (let i = 1; i <= 9; i++) {
    client.subscribe(`jam1liau2/sw${i}/state`, (err) => {
      if (err) console.log(`訂閱 sw${i}/state 失敗`, err);
    });
  }
});

/* 處理收到訊息 */
client.on("message", (topic, message) => {
  const text = message.toString().trim();

  // 匹配 jam1liau2/sw*/state
  const swMatch = topic.trim().match(/jam1liau2\/sw(\d+)\/state/i);
  if (swMatch) {
    const id = parseInt(swMatch[1]);
    deviceState[id] = (text.toUpperCase() === "ON");
    updateButton(id);
  }
});

/* 切換裝置 - 修正版 */
function toggleDevice(id) {
  // 核心修正：如果現在是 true(ON)，則發送 OFF；反之發送 ON
  const targetState = deviceState[id] ? "OFF" : "ON";
  
  console.log(`發送指令：sw${id} -> ${targetState}`); // 調試用
  
  // 修改方式 B (使用變數 targetState)

  client.publish(`jam1liau2/sw${id}/set`, targetState, { qos: 1, retain: true });

  /* 選擇性：預判更新 (讓 UI 反應更快)
     如果您希望按下瞬間按鈕就變色，而不等 MQTT 回傳，可以取消下方註釋 */
  // deviceState[id] = !deviceState[id];
  // updateButton(id);
}

/* 更新按鈕顏色 */
function updateButton(id) {
  const btn = document.getElementById("btn" + id);
  if (!btn) return;
  const name = DEVICE_NAMES[id - 1];
  if (deviceState[id]) {
    btn.classList.add("on");
    btn.innerText = `${name}（開）`;
  } else {
    btn.classList.remove("on");
    btn.innerText = `${name}（關）`;
  }
}

/* ===== 語音控制 ===== */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SpeechRecognition) {
  const recognition = new SpeechRecognition();
  recognition.lang = "zh-TW";
  recognition.interimResults = true;

  recognition.onstart = () => {
    document.getElementById("voiceText").innerText = "🎧 聆聽中...";
  };

  recognition.onresult = (e) => {
    const text = e.results[0][0].transcript;
    document.getElementById("voiceText").innerText = text;
    handleVoice(text);
  };

  recognition.onend = () => {
    setTimeout(() => document.getElementById("voiceText").innerText = "請說指令…", 2000);
  };

  document.getElementById("micBtn").onclick = () => recognition.start();
}

function handleVoice(text) {
  const isOn  = /開|打開|開啟/.test(text);
  const isOff = /關|關閉/.test(text);
  if (!isOn && !isOff) return;

  let id = null;
  DEVICE_NAMES.forEach((name, i) => {
    if (text.includes(name)) id = i + 1;
  });

  const m = text.match(/第?\s*(\d+)/);
  if (!id && m) id = parseInt(m[1]);

  if (id >= 1 && id <= 9) {
    // 修改方式 A (直接判斷 isOn)

    client.publish(`jam1liau2/sw${id}/set`, (isOn ? "ON" : "OFF"), { qos: 1, retain: true });
  }
}
</script>

</body>
</html>