<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
window.addEventListener('DOMContentLoaded', () => {
  const deviceState = {};
  const buttonsDiv = document.getElementById("buttons");

  const BROKER = "wss://yb01715d.ala.asia-southeast1.emqxsl.com:8084/mqtt";
  const USERNAME = "jyhon";
  const PASSWORD = "jyhon";
  const TOPIC_CMD   = "jam1liau2/item1";
  const TOPIC_REPLY = "jam1liau2/reply";

  for (let i = 1; i <= 9; i++) {
    deviceState[i] = false;
    const btn = document.createElement("button");
    btn.id = "btn" + i;
    btn.innerText = "設備 " + i + "（關）";
    btn.onclick = () => toggleDevice(i);
    buttonsDiv.appendChild(btn);
  }

  const client = mqtt.connect(BROKER, {
    username: USERNAME,
    password: PASSWORD,
    reconnectPeriod: 3000
  });

  client.on("connect", () => {
    document.getElementById("status").innerText = "MQTT 已連線";
    client.subscribe(TOPIC_REPLY);
  });

  client.on("message", (topic, message) => {
    if (topic !== TOPIC_REPLY) return;
    const text = message.toString();
    const match = text.match(/#(\d+)\s+power\s+(on|off)/i);
    if (!match) return;
    const id = parseInt(match[1]);
    const state = match[2].toLowerCase() === "on";
    deviceState[id] = state;
    updateButton(id);
  });

  function toggleDevice(id) {
    const payload = id + (deviceState[id] ? "0" : "1");
    client.publish(TOPIC_CMD, payload);
  }

  function updateButton(id) {
    const btn = document.getElementById("btn" + id);
    if (deviceState[id]) {
      btn.classList.add("on");
      btn.innerText = "設備 " + id + "（開）";
    } else {
      btn.classList.remove("on");
      btn.innerText = "設備 " + id + "（關）";
    }
  }
});
</script>
