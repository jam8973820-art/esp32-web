<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ESP32-S3 家電控制</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- App / 桌面圖示 -->
<link rel="icon" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-180.png">

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  text-align: center;
}
h2 { margin: 15px 0; }
.grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  max-width: 360px;
  margin: auto;
}
button {
  height: 70px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
  background: #999;
  color: white;
  cursor: pointer;
}
button.on { background: #2ecc71; }
#status { margin: 10px; font-size: 15px; }
#voiceText {
  margin: 10px;
  font-size: 16px;
  color: #333;
}
#voiceBtn {
  margin: 10px;
  padding: 10px 20px;
  font-size: 18px;
}
</style>
</head>

<body>

<h2>ESP32 家電控制</h2>
<div id="status">MQTT 連線中...</div>

<button id="voiceBtn">🎤 語音控制</button>
<div id="voiceText">請說指令…</div>

<div class="grid" id="buttons"></div>

<script>
window.addEventListener("DOMContentLoaded", () => {

  /* ========= MQTT 設定 ========= */
  const BROKER = "wss://yb01715d.ala.asia-southeast1.emqxsl.com:8084/mqtt";
  const USERNAME = "jyhon";
  const PASSWORD = "jyhon";
  const TOPIC_CMD   = "jam1liau2/item1";
  const TOPIC_REPLY = "jam1liau2/reply";

  // ✅ 每次載入都產生不同 ClientID
  const CLIENT_ID = "web_" + Math.random().toString(16).substr(2, 8);
  /* ============================ */

  /* ===== 家電名稱（自行修改）===== */
  const deviceNames = [
    "房間電燈",
    "戶外電燈",
    "客廳電燈",
    "客廳風扇",
    "設備5",
    "設備6",
    "設備7",
    "設備8",
    "設備9"
  ];

  const deviceState = {};
  const buttonsDiv = document.getElementById("buttons");

  deviceNames.forEach((name, i) => {
    const id = i + 1;
    deviceState[id] = false;

    const btn = document.createElement("button");
    btn.id = "btn" + id;
    btn.innerText = `${name}（關）`;
    btn.onclick = () => sendCmd(id, !deviceState[id]);
    buttonsDiv.appendChild(btn);
  });

  /* ===== MQTT 連線 ===== */
  const client = mqtt.connect(BROKER, {
    clientId: CLIENT_ID,
    username: USERNAME,
    password: PASSWORD,
    reconnectPeriod: 3000
  });

  client.on("connect", () => {
    document.getElementById("status").innerText =
      "MQTT 已連線 (" + CLIENT_ID + ")";
    client.subscribe(TOPIC_REPLY);
  });

  client.on("message", (topic, msg) => {
    const text = msg.toString(); // #1 power on
    const m = text.match(/#(\d+)\s+power\s+(on|off)/i);
    if (!m) return;

    const id = parseInt(m[1]);
    const on = m[2].toLowerCase() === "on";
    deviceState[id] = on;
    updateBtn(id);
  });

  function sendCmd(id, on) {
    client.publish(TOPIC_CMD, id + (on ? "1" : "0"));
  }

  function updateBtn(id) {
    const btn = document.getElementById("btn" + id);
    const name = deviceNames[id - 1];
    btn.classList.toggle("on", deviceState[id]);
    btn.innerText = `${name}（${deviceState[id] ? "開" : "關"}）`;
  }

  /* ===== Google 語音輸入 ===== */
  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    document.getElementById("voiceText").innerText =
      "⚠ 此瀏覽器不支援語音輸入";
    return;
  }

  const recog = new SpeechRecognition();
  recog.lang = "zh-TW";
  recog.interimResults = true;

  document.getElementById("voiceBtn").onclick = () => {
    document.getElementById("voiceText").innerText = "🎧 聆聽中...";
    recog.start();
  };

  recog.onresult = (e) => {
    const text = Array.from(e.results).map(r => r[0].transcript).join("");
    document.getElementById("voiceText").innerText = text;
  };

  recog.onend = () => {
    parseVoice(document.getElementById("voiceText").innerText);
  };

  function parseVoice(text) {
    text = text.replace(/\s/g, "");

    deviceNames.forEach((name, i) => {
      if (!text.includes(name)) return;

      const id = i + 1;

      if (/(開|打開|開啟)/.test(text)) {
        sendCmd(id, true);
      }
      if (/(關|關閉)/.test(text)) {
        sendCmd(id, false);
      }
    });
  }

});
</script>

</body>
</html>
